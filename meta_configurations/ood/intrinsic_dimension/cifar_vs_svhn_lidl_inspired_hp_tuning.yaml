# In this set of experiments
# I consider a flow model on svhn or cifar and run the analytical Gaussian convolution
# method on the models with in and out of distribution datasets and plot the convolution values I obtain
# No sampling is done in this sweep for fast computation
project: intrinsic-dimension
sweep_name: cifar-vs-svhn-lidl-inspired-smart-hp-tuning
entity: dgm-l6
count: 10000
method: grid

# Change the name of the run to [in_distribution_dataset]_vs_[out_of_distribution_dataset]_[run_name]
# using the dysweep name changer for better readability
run_name_changer:
  expression: |
    from meta_configurations import *
  function_of_interest: run_name_changer

# BASE configuration which is being used
base_config:
  data:
    # specify the datasets and dataloader configurations for the in and out of distribution data.
    in_distribution:
      dataloader_args:
        make_valid_loader: false
      pick_loader: train
    out_of_distribution:
      dataloader_args:
        make_valid_loader: false
    # for reproducibility
    seed: 10
  ood:
    # to bypass or not to bypass
    bypass_visualization: True

    pick_single: False
    use_dataloader: True
    seed: 100
    histogram_limit: 2000
    pick_count: 1000

    # The degree of visualization for samples
    samples_visualization: 2
    
    # The OOD detection method in use
    method: ood.methods.intrinsic_dimension.IntrinsicDimensionScore
    method_args:

      verbose: 2
      adaptive_measurement: True

      intrinsic_dimension_calculator_args: 

        encoding_model_class: ood.methods.linear_approximations.EncodingFlow
        encoding_model_args:
          chunk_size: 1
          use_functorch: True
          use_forward_mode: True
          use_vmap: False
          verbose: 2

        verbose: 0

      ood_loader_limit: 3
      ood_loader_buffer_size: 3

sweep_configuration:

  dy__upsert:
    - ood:
        method_args:
          dimension_tolerance:
            sweep: True
            sweep_identifier: A_dim_tol
            values: [0.2, 0.25, 0.33, 0.5, 0.1, 0.05]
    - ood:
        method_args:
          outlier_detection_args:
            z_score_threshold:
              sweep: True
              sweep_identifier: B_z_score_threshold
              values: [2, 3]
    - ood:
        method_args:
          outlier_detection_args:
            iqr_coeff:
              sweep: True
              sweep_identifier: B_iqr_coeff
              values: [1.5, 3.0, 10.0]

    - sweep: True
      sweep_identifier: Z_in_distribution_model
      sweep_alias:
        # colorful flows
        - flow_cifar10_RQ_NSF
        - flow_svhn_RQ_NSF
      values:
        - base_model:
            config_dir: checkpoints-zei1ialy/PiecewiseRationalQuadraticCouplingTransform_cifar10_heteronomous_owjcfa1x_final/run_config.json
            checkpoint_dir: checkpoints-zei1ialy/PiecewiseRationalQuadraticCouplingTransform_cifar10_heteronomous_owjcfa1x_final/checkpoints/de_nf_best_valid.pt
          data:
            in_distribution:
              dataloader_args:
                dataset: cifar10
                train_batch_size: 8
                valid_batch_size: 8
                test_batch_size: 8
            out_of_distribution:
              dataloader_args:
                train_batch_size: 8
                valid_batch_size: 8
                test_batch_size: 8
        - base_model:
            config_dir: checkpoints-zei1ialy/PiecewiseRationalQuadraticCouplingTransform_svhn_hittitics_znujejsh_final/run_config.json
            checkpoint_dir: checkpoints-zei1ialy/PiecewiseRationalQuadraticCouplingTransform_svhn_hittitics_znujejsh_final/checkpoints/de_nf_best_valid.pt
          data:
            in_distribution:
              dataloader_args:
                dataset: svhn
                train_batch_size: 8
                valid_batch_size: 8
                test_batch_size: 8
            out_of_distribution:
              dataloader_args:
                train_batch_size: 8
                valid_batch_size: 8
                test_batch_size: 8
        
    - data:
        out_of_distribution:
          pick_loader: test
          dataloader_args:
            dy__upsert:
              - sweep: True
                sweep_identifier: Y_ood_picker
                sweep_alias:
                - svhn
                - cifar10
                values:
                - dataset: svhn
                - dataset: cifar10